<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMEN UTAMA ---
    const sidebar = document.getElementById('sidebar');
    const pageTitle = document.getElementById('pageTitle');
    
    // --- HALAMAN (VIEWS) ---
    const welcomePage = document.getElementById('welcomePage');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const dashboardPage = document.getElementById('dashboardPage');
    const generatorPage = document.getElementById('generatorPage');
    const profilePage = document.getElementById('profilePage');
    const adminPage = document.getElementById('adminPage');

    // --- TOMBOL & LINK ---
    const showLoginBtn = document.getElementById('showLogin');
    const showRegisterBtn = document.getElementById('showRegister');
    const linkToRegister = document.getElementById('linkToRegister');
    const linkToLogin = document.getElementById('linkToLogin');
    const menuHome = document.getElementById('menuHome');
    const menuGenerator = document.getElementById('menuGenerator');
    const menuProfile = document.getElementById('menuProfile');
    const menuLogout = document.getElementById('menuLogout');
    const goToGeneratorBtn = document.getElementById('goToGeneratorBtn');
    const adminMenuItem = document.getElementById('adminMenuItem');
    const menuAdmin = document.getElementById('menuAdmin');
    
    // --- FRAME & OUTPUT ---
    const adminFrame = document.getElementById('adminFrame');
    const loginUserForm = document.getElementById('loginUserForm');
    const registerUserForm = document.getElementById('registerUserForm');
    const dashboardWelcomeMessage = document.getElementById('dashboardWelcomeMessage');
    const generatorFrame = document.getElementById('generatorFrame');
    const loginMessage = document.getElementById('loginMessage');
    const registerMessage = document.getElementById('registerMessage');
    const profileTrialStatus = document.getElementById('profileTrialStatus');

    // --- DATA ---
    let currentUser = null;
    // URL Web App Anda yang sudah benar
    const webAppUrl = "https://script.google.com/macros/s/AKfycbyTeTKtEAidA6L-TNBRYbeOHF9GPDuEcS-zY6WmRGUInE7-XgXQuYsaI4qE1NnwS0Ei/exec";

    // --- FUNGSI-FUNGSI HELPER ---
    function showPage(pageElement, title) {
      const allPages = [welcomePage, loginForm, registerForm, dashboardPage, generatorPage, profilePage, adminPage];
      allPages.forEach(page => { if(page) page.classList.add('hidden'); });
      if (pageElement) {
        pageElement.classList.remove('hidden');
        pageTitle.textContent = title;
      }
    }

    function updateMessage(element, message, type) {
        if (!element) return;
        element.textContent = message;
        element.className = `message ${type}`;
        element.style.display = 'block';
        setTimeout(() => { if (element) { element.style.display = 'none'; element.textContent = ''; } }, 5000);
    }
    
    function updateProfileAndTrialStatus() {
        if (!currentUser || !profileTrialStatus) return;
        
        document.getElementById('profileFullName').textContent = currentUser.fullName;
        document.getElementById('profileEmail').textContent = currentUser.email;
        document.getElementById('profileSubscriptionStatus').textContent = currentUser.subscriptionStatus;

        if (currentUser.subscriptionStatus === 'Trial') {
            const clicksLeft = MAX_CLICKS_FROM_SERVER - currentUser.trialClicks;
            if (clicksLeft > 0) {
              profileTrialStatus.innerHTML = `<strong>Penggunaan Trial:</strong> ${currentUser.trialClicks} / ${MAX_CLICKS_FROM_SERVER}. Sisa ${clicksLeft} kali.`;
            } else {
              profileTrialStatus.innerHTML = `<strong>Penggunaan Trial:</strong> Masa trial Anda telah habis. Silakan hubungi admin untuk upgrade.`;
            }
        } else if (currentUser.subscriptionStatus === 'Admin') {
            profileTrialStatus.textContent = 'Anda login sebagai Administrator sistem.';
        } else {
            profileTrialStatus.textContent = 'Anda adalah pengguna Premium.';
        }
    }

    function handleLoginSuccess(response) {
      if (response.success) {
          currentUser = response.userData;
          localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
          sidebar.classList.remove('fully-hidden');
          
          if (currentUser.isAdmin) {
              adminMenuItem.classList.remove('hidden');
          } else {
              adminMenuItem.classList.add('hidden');
          }

          updateProfileAndTrialStatus();
          showPage(dashboardPage, 'Dasbor');
          loadDashboardData();
        } else {
          updateMessage(loginMessage, response.message, 'error');
        }
    }

    // --- FUNGSI UTAMA ---
    function loadDashboardData() {
        if (!currentUser) return;
        
        if (currentUser.isAdmin) {
            dashboardWelcomeMessage.textContent = `Selamat datang, Administrator!`;
            document.getElementById('stat-visitors-today').textContent = 'N/A';
            document.getElementById('stat-rpp-today').textContent = 'N/A';
            document.getElementById('stat-signups-today').textContent = 'N/A';
            document.getElementById('stat-trial-users').textContent = 'N/A';
            return;
        };

        dashboardWelcomeMessage.textContent = `Selamat datang, ${currentUser.fullName}!`;
        google.script.run
            .withSuccessHandler(response => {
                if (response.success) {
                    const stats = response.stats;
                    document.getElementById('stat-visitors-today').textContent = stats.visitorsToday;
                    document.getElementById('stat-rpp-today').textContent = stats.rppToday;
                    document.getElementById('stat-signups-today').textContent = stats.signupsToday;
                    document.getElementById('stat-trial-users').textContent = stats.trialUsers;
                }
            })
            .withFailureHandler(error => console.error("Gagal memanggil getDashboardStats:", error))
            .getDashboardStats();
    }

    function openGenerator() {
      if (!currentUser) return;
      
      if (!currentUser.isAdmin && currentUser.subscriptionStatus === 'Trial' && currentUser.trialClicks >= MAX_CLICKS_FROM_SERVER) {
        alert('Masa trial Anda telah habis. Silakan hubungi admin untuk upgrade.');
        showPage(profilePage, 'Profil Pengguna');
        return;
      }
      
      if (!currentUser.isAdmin) {
        google.script.run.withSuccessHandler((trialResponse) => {
            if (trialResponse.success) {
                currentUser.trialClicks = trialResponse.newClicks;
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                updateProfileAndTrialStatus();
                loadGeneratorPage();
            } else { 
                alert(trialResponse.message); 
            }
        }).recordTrialClick(currentUser.id);
      } else {
        loadGeneratorPage();
      }
    }

    function loadGeneratorPage() {
        generatorFrame.src = webAppUrl + "?page=generator";
        showPage(generatorPage, 'Generator RPP'); 
    }

    // --- EVENT LISTENERS ---
    if (showLoginBtn) showLoginBtn.addEventListener('click', () => showPage(loginForm, 'Login Pengguna'));
    if (showRegisterBtn) showRegisterBtn.addEventListener('click', () => showPage(registerForm, 'Daftar Pengguna Baru'));
    if (linkToLogin) linkToLogin.addEventListener('click', (e) => { e.preventDefault(); showPage(loginForm, 'Login Pengguna'); });
    if (linkToRegister) linkToRegister.addEventListener('click', (e) => { e.preventDefault(); showPage(registerForm, 'Daftar Pengguna Baru'); });

    if (loginUserForm) loginUserForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        updateMessage(loginMessage, 'Mencoba login...', 'info');
        google.script.run
            .withSuccessHandler(handleLoginSuccess)
            .withFailureHandler(error => updateMessage(loginMessage, 'Terjadi kesalahan: ' + error.message, 'error'))
            .loginUser(email, password);
    });

    if (registerUserForm) registerUserForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const userData = {
            fullName: document.getElementById('registerFullName').value,
            email: document.getElementById('registerEmail').value,
            password: document.getElementById('registerPassword').value,
        };
        updateMessage(registerMessage, 'Mendaftarkan...', 'info');
        google.script.run.withSuccessHandler(response => {
            if (response.success) {
                updateMessage(registerMessage, response.message, 'success');
                registerUserForm.reset();
                setTimeout(() => showPage(loginForm, 'Login Pengguna'), 3000);
            } else {
                updateMessage(registerMessage, response.message, 'error');
            }
        }).withFailureHandler(error => updateMessage(registerMessage, 'Terjadi kesalahan: ' + error.message, 'error'))
        .registerUser(userData);
    });
    
    // Menu Sidebar
    if (menuHome) menuHome.addEventListener('click', (e) => { e.preventDefault(); if(currentUser) { showPage(dashboardPage, 'Dasbor'); loadDashboardData(); } });
    if (menuGenerator) menuGenerator.addEventListener('click', (e) => { e.preventDefault(); openGenerator(); });
    if (goToGeneratorBtn) goToGeneratorBtn.addEventListener('click', openGenerator);
    if (menuProfile) menuProfile.addEventListener('click', (e) => { e.preventDefault(); if(currentUser) { updateProfileAndTrialStatus(); showPage(profilePage, 'Profil Pengguna'); } });
    
    if (menuAdmin) menuAdmin.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentUser && currentUser.isAdmin) {
            adminFrame.src = webAppUrl + "?page=admin";
            showPage(adminPage, 'Panel Admin');
        }
    });

    if (menuLogout) menuLogout.addEventListener('click', (e) => {
        e.preventDefault();
        currentUser = null;
        localStorage.removeItem('loggedInUser');
        sidebar.classList.add('fully-hidden');
        adminMenuItem.classList.add('hidden');
        showPage(welcomePage, 'Selamat Datang');
    });

    // --- LOGIKA AWAL SAAT HALAMAN DIMUAT ---
    const storedUser = localStorage.getItem('loggedInUser');
    if (storedUser) {
      currentUser = JSON.parse(storedUser);
      handleLoginSuccess({ success: true, userData: currentUser });
    } else {
      sidebar.classList.add('fully-hidden');
      showPage(welcomePage, 'Selamat Datang');
    }
  });
</script>
